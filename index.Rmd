---
title: "Big Data task 2"
output:
  prettydoc::html_pretty:
    theme: architect
highlight: github
resource_files:
  - renv.lock
---

```{r include=FALSE}
knitr::opts_chunk$set(echo=FALSE)

library(jsonencryptor)
library(bigrquery)
library(DBI)
library(dplyr)
library(lubridate)
library(ggplot2)
library(sparklyr)

source("spark_analysis.R")

```

# Train strikes between March and May by travel reason

```{r fig.width=8, fig.retina=3}

ggplot(data = strike_data_to_plot, aes(x = date,
                                  y = perc,
                                  group = travel_reason,
                                  colour = travel_reason))+
  geom_line(linewidth = 1)+
  scale_colour_manual(values = palette)+
  scale_y_continuous(labels = scales::label_percent(),
                     name = "")+
  scale_x_date(name = "Date")+
  ggplot2::theme(panel.background = ggplot2::element_rect(fill = "white"),
                 panel.grid.major.y = ggplot2::element_line(colour = "grey", linewidth = 0.1),
                 strip.background = ggplot2::element_rect(fill = "white"),
                 axis.line.x = ggplot2::element_line(colour = "black", linewidth = 1),
                 axis.line.y = ggplot2::element_line(colour = "black", linewidth = 1))+
  geom_vline(xintercept = all_strike_date,
             colour = "grey")+
  geom_vline(xintercept = all_bank_hols,
             colour = "grey",
             linetype = "dashed")+
  geom_hline(yintercept = 1,
             colour = "black",
             size = 1)+
  annotate("label",
           label = "Solid line =\n Train strikes",
           x = as.Date("2023-05-21"),
           y = 1.5)+
  annotate("label",
           label = "Dashed line =\n Bank holidays",
           x = as.Date("2023-05-21"),
           y = 1.35)+
  labs(colour = "Reason for travel")
```

This chart shows the number of people in the area surrounding Waterloo train station between the times of 8am and 7pm Monday to Friday to establish the effects that train strikes have on travel. Strike days as well as bank holidays are noted on the chart to allow insight into why there have been significant dips in 

Travel across all recorded reasons for travel we're especially affected in the March strikes, which could be explained by the quick succession of multiple days of strikes. Periods where there were only two days of striks appear to have less of an impact. 

# Train strikes between March and May by socioeconomic background

```{r fig.width=8, fig.retina=3}

ggplot(data = se_background_sc, aes(x = date,
                                         y = perc,
                                         group = socioeconomic_background,
                                         colour = socioeconomic_background))+
  geom_line()+
  scale_y_continuous(labels = scales::percent)+
  chart_theme+
  geom_hline(yintercept = 1,
             colour = "black",
             linewidth = 1)+
  geom_vline(xintercept = all_strike_date,
             colour = "grey")+
  geom_vline(xintercept = all_bank_hols,
             colour = "grey",
             linetype = "dashed")+
  facet_wrap(~socioeconomic_background,
             scales = "free")

```

This next chart performs the same analysis as the one above, regarding travel during train strikes, but shows how people from different socioeconomic backgrounds are affected. The grades (AB, C1, C2, DE) refer to the classification [developed by the ONS](https://ukgeographics.co.uk/blog/social-grade-a-b-c1-c2-d-e), where AB is the higher socioeconomic background and DE being the lowest. 

Visually, we can see that C1/C2 (that covers skilled manual and junior professional occupations) is marginally most affected by train strikes, while DE(unskilled manual occupations or unemployed) seem less affected, especially during the 2-day strikes. 

# Breakdown of travel by gender surrounding a six nations rugby match in Twickenham

```{r fig.width=8, fig.retina=3}
ggplot(data = twickenham_by_gender_sc, aes(x = datetime,
                                                y = count,
                                                group = gender,
                                                colour = gender))+
  geom_line()+
  geom_rect(data = rugby_times,
            aes(xmin = xmin, 
                xmax = xmax, 
                ymin = ymin, 
                ymax = ymax),
            fill = "grey", alpha = 0.3,
            inherit.aes = FALSE)+
  chart_theme+
  scale_x_datetime(name = "",
                   date_labels = "%H:%M")+
  scale_y_continuous(labels = scales::comma,
                     name = "")
```

Another area of interest this dataset can cover is how large events affect travel, with a particular interest in women's safety. This chart covers the crowds surrounding Twickenham stadium during a rugby match, with the time the match took place with 2 hours either side highlighted. By extending the analysis we can pick out areas and times where women may not use trains as much and flag that for potential risks. 